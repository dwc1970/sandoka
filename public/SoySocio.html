<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Socio - C.S.D. Constitución</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --amarillo: #fbc02d; --negro: #1a1d23; --blanco: #ffffff; --gris: #f4f4f4; --rojo: #d32f2f; --verde: #4caf50; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background-color: var(--gris); }
        header { background: var(--amarillo); padding: 15px 0; text-align: center; border-bottom: 4px solid var(--negro); }
        nav a { text-decoration: none; color: var(--negro); font-weight: 800; text-transform: uppercase; margin: 0 15px; }
        .container { max-width: 800px; margin: 40px auto; padding: 20px; }
        
        /* Alarma de Deuda */
        .alarma-deuda { display: none; background: #ffebee; color: var(--rojo); border: 2px solid var(--rojo); padding: 15px; border-radius: 15px; margin-bottom: 20px; text-align: center; font-weight: bold; }

        /* Carnet */
        .carnet { background: var(--negro); color: white; border-radius: 20px; overflow: hidden; position: relative; box-shadow: 0 15px 30px rgba(0,0,0,0.3); display: flex; flex-wrap: wrap; border: 3px solid var(--amarillo); }
        .carnet-header { background: var(--amarillo); width: 100%; padding: 15px; color: var(--negro); text-align: center; font-weight: 900; text-transform: uppercase; letter-spacing: 2px; }
        .carnet-foto { flex: 1; min-width: 200px; padding: 30px; text-align: center; background: rgba(255,255,255,0.05); display: flex; flex-direction: column; align-items: center; }
        .foto-usuario { width: 150px; height: 180px; background: #333; border-radius: 15px; border: 3px solid var(--amarillo); display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        .foto-usuario img { width: 100%; height: 100%; object-fit: cover; }
        .foto-usuario i { font-size: 4rem; color: var(--amarillo); }
        .btn-subir { margin-top: 10px; font-size: 0.8rem; color: var(--amarillo); cursor: pointer; text-decoration: underline; font-weight: bold; }
        
        .status-badge { background: var(--verde); color: white; padding: 5px 15px; border-radius: 50px; font-size: 0.9rem; font-weight: bold; display: inline-block; margin-top: 15px; }
        .status-badge.deuda { background: var(--rojo); }

        .carnet-info { flex: 2; padding: 30px; display: flex; flex-direction: column; justify-content: center; }
        .dato-socio { margin: 10px 0; font-size: 1.1rem; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .label { color: var(--amarillo); font-size: 0.8rem; display: block; text-transform: uppercase; }

        /* Botones */
        .acciones { margin-top: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .btn-panel { background: white; padding: 20px; border-radius: 15px; text-align: center; color: var(--negro); font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: 0.3s; border: none; cursor: pointer; font-size: 1rem; }
        .btn-panel:hover { transform: translateY(-5px); background: var(--amarillo); }
        .btn-panel i { display: block; font-size: 2rem; margin-bottom: 10px; }

        .cerrar-sesion { display: block; text-align: center; margin-top: 40px; color: #888; text-decoration: none; font-weight: bold; }
        #inputFoto { display: none; }
    </style>
</head>
<body>

    <header>
        <nav>
            <a href="index.html">Inicio</a>
            <a href="el_club.html">El Club</a>
            <a href="liga.html">Fixture</a>
        </nav>
    </header>

    <div class="container">
        <div id="alarmaDeuda" class="alarma-deuda">⚠️ ATENCIÓN: Debes la cuota del mes. Por favor regulariza tu situación.</div>

        <h1 style="text-align: center; text-transform: uppercase;">Mi Panel de Socio</h1>

        <div class="carnet" id="areaCarnet">
            <div class="carnet-header">Socio Oficial - C.S.D. Constitución</div>
            <div class="carnet-foto">
                <div class="foto-usuario" id="contenedorFoto">
                    <i class="fas fa-user" id="iconoDefecto"></i>
                    <img id="fotoPerfil" style="display:none;">
                </div>
                <label for="inputFoto" class="btn-subir">Cambiar Foto</label>
                <input type="file" id="inputFoto" accept="image/*" onchange="subirFoto(event)">
                <div id="badgeEstado" class="status-badge">AL DÍA</div>
            </div>
            <div class="carnet-info">
                <div class="dato-socio"><span class="label">Nombre y Apellido</span><strong id="nombreSocio">---</strong></div>
                <div class="dato-socio"><span class="label">DNI</span><strong id="dniSocio">---</strong></div>
                <div class="dato-socio"><span class="label">Nro de Socio</span><strong id="nroSocio">---</strong></div>
                <div class="dato-socio"><span class="label">Categoría</span><strong id="categoriaSocio">Activo</strong></div>
                <div style="text-align: right;"><i class="fas fa-qrcode" style="font-size: 3rem; opacity: 0.7;"></i></div>
            </div>
        </div>

        <div class="acciones">
            <button class="btn-panel" onclick="window.location.href='cuotas.html'"><i class="fas fa-money-check-alt"></i>Pagar Cuota</button>
            <button class="btn-panel" onclick="window.location.href='ticket.html'"><i class="fas fa-ticket-alt"></i>Comprar Entrada</button>
            <button class="btn-panel" onclick="descargarCarnet()"><i class="fas fa-id-card"></i>Descargar Carnet</button>
            <button class="btn-panel" onclick="location.reload()"><i class="fas fa-sync"></i>Actualizar Datos</button>
        </div>
        <a href="#" class="cerrar-sesion" onclick="cerrarSesion()">Cerrar Sesión</a>
    </div>

    <script>
        const dniLogueado = sessionStorage.getItem('socioLogueado');

        function cargarSocio() {
            if (!dniLogueado) { 
                window.location.href = "socios.html"; 
                return; 
            }
            
            // Buscamos al socio en la lista de localStorage
            const listaSocios = JSON.parse(localStorage.getItem('listaSocios')) || [];
            const socio = listaSocios.find(s => s.dni === dniLogueado);
            
            if (socio) {
                document.getElementById('nombreSocio').innerText = socio.nombre || "Socio";
                document.getElementById('dniSocio').innerText = socio.dni || "---";
                document.getElementById('nroSocio').innerText = socio.nroSocio || "---";
                document.getElementById('categoriaSocio').innerText = socio.categoria || "Activo";

                // Si tiene foto guardada, la cargamos
                if (socio.foto) {
                    const img = document.getElementById('fotoPerfil');
                    img.src = socio.foto;
                    img.style.display = "block";
                    document.getElementById('iconoDefecto').style.display = "none";
                }

                // Estado de deuda
                const badge = document.getElementById('badgeEstado');
                if (socio.estado === "deuda" || socio.estado === "deudor") {
                    document.getElementById('alarmaDeuda').style.display = "block";
                    badge.innerText = "DEBE CUOTA";
                    badge.classList.add('deuda');
                } else {
                    document.getElementById('alarmaDeuda').style.display = "none";
                    badge.innerText = "AL DÍA";
                    badge.classList.remove('deuda');
                }
            } else {
                alert("Sesión inválida.");
                cerrarSesion();
            }
        }

        function subirFoto(event) {
            const archivo = event.target.files[0];
            if (!archivo) return;

            const lector = new FileReader();
            lector.onload = function(e) {
                const imgRaiz = new Image();
                imgRaiz.src = e.target.result;

                imgRaiz.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Tamaño carnet
                    canvas.width = 300; 
                    canvas.height = 400;
                    ctx.drawImage(imgRaiz, 0, 0, 300, 400);
                    
                    // Convertir a Base64 comprimido
                    const fotoBase64 = canvas.toDataURL('image/jpeg', 0.7);

                    // Actualizar en el array general de socios
                    let lista = JSON.parse(localStorage.getItem('listaSocios')) || [];
                    const index = lista.findIndex(s => s.dni === dniLogueado);

                    if (index !== -1) {
                        lista[index].foto = fotoBase64;
                        localStorage.setItem('listaSocios', JSON.stringify(lista));
                        
                        // Actualizar la vista inmediatamente
                        const img = document.getElementById('fotoPerfil');
                        img.src = fotoBase64;
                        img.style.display = "block";
                        document.getElementById('iconoDefecto').style.display = "none";
                        
                        alert("¡Foto actualizada correctamente!");
                    }
                };
            };
            lector.readAsDataURL(archivo);
        }

        function descargarCarnet() {
            const area = document.getElementById('areaCarnet');
            html2canvas(area, { 
                scale: 2, 
                backgroundColor: "#1a1d23",
                useCORS: true 
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'Carnet-Constitucion-' + dniLogueado + '.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }

        function cerrarSesion() {
            sessionStorage.removeItem('socioLogueado');
            window.location.href = "socios.html";
        }

        // Ejecutar al cargar la página
        window.onload = cargarSocio;
    </script>
</body>
</html>